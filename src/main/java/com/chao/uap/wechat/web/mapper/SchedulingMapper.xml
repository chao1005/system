<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hyetec.uap.wechat.mapper.SchedulingMapper" >
  <!--
  Copyright (c) 2017 by Hyetec  Corporation all right reserved.
  2017年11月20日 11:09
  -->
  <resultMap id="BaseResultMap" type="com.hyetec.uap.wechat.model.Scheduling" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="pk_id" property="pkId" jdbcType="BIGINT" />
    <result column="expert_id" property="expertId" jdbcType="BIGINT" />
    <result column="advice_date" property="adviceDate" jdbcType="DATE" />
    <result column="start_time" property="startTime" jdbcType="VARCHAR" />
    <result column="end_time" property="endTime" jdbcType="VARCHAR" />
    <result column="capacity" property="capacity" jdbcType="INTEGER" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="daf_end" property="dafEnd" jdbcType="INTEGER" />
    <result column="status" property="status" jdbcType="INTEGER" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    pk_id, expert_id, advice_date, start_time, end_time, capacity, remark, status, create_time,daf_end
  </sql>
  
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from f_scheduling
    where pk_id = #{pkId,jdbcType=BIGINT} 
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Long" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    delete from f_scheduling
    where pk_id = #{pkId,jdbcType=BIGINT}
  </delete>
  <insert id="insert" parameterType="com.hyetec.uap.wechat.model.Scheduling" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="pkId" order="AFTER" >
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into f_scheduling (expert_id, advice_date, start_time, 
      end_time, capacity, remark, daf_end,
      status, create_time)
    values (#{expertId,jdbcType=BIGINT}, #{adviceDate,jdbcType=DATE}, #{startTime,jdbcType=TIME}, 
      #{endTime,jdbcType=TIME}, #{capacity,jdbcType=INTEGER}, #{remark,jdbcType=VARCHAR}, 
      #{dafEnd,jdbcType=INTEGER}, 
      #{status,jdbcType=INTEGER}, #{createTime,jdbcType=TIMESTAMP})
  </insert>
  <insert id="insertSelective" parameterType="com.hyetec.uap.wechat.model.Scheduling" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <selectKey resultType="java.lang.Long" keyProperty="pkId" order="AFTER" >
      SELECT LAST_INSERT_ID()
    </selectKey>
    insert into f_scheduling
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="expertId != null" >
        expert_id,
      </if>
      <if test="adviceDate != null" >
        advice_date,
      </if>
      <if test="startTime != null" >
        start_time,
      </if>
      <if test="endTime != null" >
        end_time,
      </if>
      <if test="capacity != null" >
        capacity,
      </if>
      <if test="remark != null" >
        remark,
      </if>
       <if test="dafEnd != null" >
        daf_end,
      </if>
      <if test="status != null" >
        status,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="expertId != null" >
        #{expertId,jdbcType=BIGINT},
      </if>
      <if test="adviceDate != null" >
        #{adviceDate,jdbcType=DATE},
      </if>
      <if test="startTime != null" >
        #{startTime,jdbcType=TIME},
      </if>
      <if test="endTime != null" >
        #{endTime,jdbcType=TIME},
      </if>
      <if test="capacity != null" >
        #{capacity,jdbcType=INTEGER},
      </if>
      <if test="remark != null" >
        #{remark,jdbcType=VARCHAR},
      </if>
      <if test="dafEnd != null" >
        #{dafEnd,jdbcType=INTEGER},
      </if>
      <if test="status != null" >
        #{status,jdbcType=INTEGER},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.hyetec.uap.wechat.model.Scheduling" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update f_scheduling
    <set >
      <if test="expertId != null" >
        expert_id = #{expertId,jdbcType=BIGINT},
      </if>
      <if test="adviceDate != null" >
        advice_date = #{adviceDate,jdbcType=DATE},
      </if>
      <if test="startTime != null" >
        start_time = #{startTime,jdbcType=TIME},
      </if>
      <if test="endTime != null" >
        end_time = #{endTime,jdbcType=TIME},
      </if>
      <if test="capacity != null" >
        capacity = #{capacity,jdbcType=INTEGER},
      </if>
      <if test="remark != null" >
        remark = #{remark,jdbcType=VARCHAR},
      </if>
      <if test="dafEnd != null" >
        daf_end = #{dafEnd,jdbcType=INTEGER},
      </if>
      <if test="status != null" >
        status = #{status,jdbcType=INTEGER},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
    </set>
    where pk_id = #{pkId,jdbcType=BIGINT}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.hyetec.uap.wechat.model.Scheduling" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update f_scheduling
    set expert_id = #{expertId,jdbcType=BIGINT},
      advice_date = #{adviceDate,jdbcType=DATE},
      start_time = #{startTime,jdbcType=TIME},
      end_time = #{endTime,jdbcType=TIME},
      capacity = #{capacity,jdbcType=INTEGER},
      remark = #{remark,jdbcType=VARCHAR},
       daf_end = #{dafEnd,jdbcType=INTEGER},
      status = #{status,jdbcType=INTEGER},
      create_time = #{createTime,jdbcType=TIMESTAMP}
    where pk_id = #{pkId,jdbcType=BIGINT}
  </update>
  <cache type="org.mybatis.caches.ehcache.EhcacheCache" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
  </cache>
  <resultMap id="AliasResultMap" type="com.hyetec.uap.wechat.model.Scheduling" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="F_SCHEDULING_PK_ID" property="pkId" jdbcType="BIGINT" />
    <result column="F_SCHEDULING_EXPERT_ID" property="expertId" jdbcType="BIGINT" />
    <result column="F_SCHEDULING_ADVICE_DATE" property="adviceDate" jdbcType="DATE" />
    <result column="F_SCHEDULING_START_TIME" property="startTime" jdbcType="TIME" />
    <result column="F_SCHEDULING_END_TIME" property="endTime" jdbcType="TIME" />
    <result column="F_SCHEDULING_CAPACITY" property="capacity" jdbcType="INTEGER" />
    <result column="F_SCHEDULING_REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="F_SCHEDULING_DAF_END" property="dafEnd" jdbcType="INTEGER" />
    <result column="F_SCHEDULING_STATUS" property="status" jdbcType="INTEGER" />
    <result column="F_SCHEDULING_CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" />
  </resultMap>
  <sql id="Alias_Column_List" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    F_SCHEDULING.PK_ID			AS	F_SCHEDULING_PK_ID,
	F_SCHEDULING.EXPERT_ID		AS	F_SCHEDULING_EXPERT_ID,
	F_SCHEDULING.ADVICE_DATE	AS	F_SCHEDULING_ADVICE_DATE,
	F_SCHEDULING.START_TIME		AS	F_SCHEDULING_START_TIME,
	F_SCHEDULING.END_TIME		AS	F_SCHEDULING_END_TIME,
	F_SCHEDULING.CAPACITY		AS	F_SCHEDULING_CAPACITY,
	F_SCHEDULING.REMARK			AS	F_SCHEDULING_REMARK,
	F_SCHEDULING.DAFEND			AS	F_SCHEDULING_DAF_END,
	F_SCHEDULING.STATUS			AS	F_SCHEDULING_STATUS,
	F_SCHEDULING.CREATE_TIME	AS	F_SCHEDULING_CREATE_TIME
  </sql>
  <!--
      以上由华源格林统一开发平台代码生成器自动生成，请在下方添加自定义的sql。 
  -->
  <select id="selectByDate" resultType="com.hyetec.uap.wechat.model.Scheduling" parameterType="java.util.Date" >
    select a.pk_id pkId , b.pk_id expertId ,d.`name` expertLevel , c.user_name expertName ,a.advice_date adviceDate,
	GROUP_CONCAT('{"start":"',date_format(a.start_time, '%h:%i' ),'","end":"',date_format(a.end_time, '%h:%i' ),'"}')  orderTime
	 from f_scheduling a 
	LEFT JOIN f_expert b ON a.expert_id=b.pk_id
	LEFT JOIN f_user c ON b.user_id=c.pk_id
	LEFT JOIN f_dictionary d ON b.`level`=d.sort
    where a.advice_date = #{adviceDate,jdbcType=DATE} and d.type = 'expertLevel' GROUP BY a.expert_id
  </select>
  <select id="selectAll" resultMap="BaseResultMap" parameterType="com.hyetec.uap.wechat.vo.SchedulingVo" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    select 
    <include refid="Base_Column_List" />
    from f_scheduling
    <where>
    	<if test="scheduling != null">
    		<if test="scheduling.expertId != null and scheduling.expertId != ''" >
    			and expert_id = #{scheduling.expertId}
    		</if>
    	</if>
    </where>
  </select>
  <select id="selectYear" resultType="com.hyetec.uap.wechat.model.Scheduling" parameterType="java.lang.Long" >
	   SELECT * FROM (select  date_format(a.advice_date, '%Y' ) year
		 from f_scheduling a 
	    where   a.expert_id =  #{userId,jdbcType=BIGINT} and a.`status` = 0
	    AND DATE_FORMAT(a.advice_date,'%Y')  >=  DATE_FORMAT(SYSDATE(),'%Y')
	     )e GROUP BY e.`year` ORDER BY e.`year` DESC
  </select>
  <select id="selectByAdviceDate" resultType="com.hyetec.uap.wechat.model.Scheduling" parameterType="com.hyetec.uap.wechat.model.Scheduling" >
   select  a.pk_id pkId ,a.start_time startTime,a.end_time endTime ,a.daf_end dafEnd FROM f_scheduling a 
   WHERE a.expert_id =#{expertId,jdbcType=BIGINT}  
   and   a.advice_date=#{adviceDate,jdbcType=DATE}   and  a.`status` = 0 ORDER BY a.start_time ASC
  </select>
  
   <select id="selectByUserId" resultType="com.hyetec.uap.wechat.model.Scheduling" parameterType="com.hyetec.uap.wechat.model.Scheduling" >
    select a.pk_id pkId , c.pk_id expertId ,d.`name` expertLevel , c.user_name expertName ,a.advice_date adviceDate
	 from f_scheduling a 
	LEFT JOIN f_expert b ON a.expert_id=b.user_id
	LEFT JOIN f_user c ON b.user_id=c.pk_id
	LEFT JOIN f_dictionary d ON b.`level`=d.sort
    where  d.type = 'expertLevel'  and a.expert_id =  #{userId,jdbcType=BIGINT} and a.`status` = 0 AND b.`status` = 0 AND DATE_FORMAT(a.advice_date,"%Y") = #{year,jdbcType=VARCHAR}
    and  DATE_FORMAT(a.advice_date,'%Y-%c-%d')  &gt;=  DATE_FORMAT(SYSDATE(),'%Y-%c-%d')
    GROUP BY a.advice_date ORDER BY a.advice_date ASC
  </select>
  
  <select id="selectExpertByDate" resultType="com.hyetec.uap.wechat.model.Scheduling" parameterType="com.hyetec.uap.wechat.model.Scheduling" >
   select a.pk_id pkId , c.pk_id expertId , c.img expertUrl ,d.`name` expertLevel , 
   c.user_name expertName ,a.advice_date adviceDate ,a.start_time startTime ,a.end_time endTime
	 from f_scheduling a 
	LEFT JOIN f_expert b ON a.expert_id=b.user_id
	LEFT JOIN f_user c ON b.user_id=c.pk_id
	LEFT JOIN f_dictionary d ON b.`level`=d.sort 
    where  d.type = 'expertLevel' and a.`status` = 0  AND b.`status` = 0  AND b.Category = #{expertCategory,jdbcType=VARCHAR}   AND a.advice_date= #{adviceDate,jdbcType=DATE}
     ORDER BY a.start_time DESC 
  </select>
  <select id="selectExpertByNowDate" resultType="com.hyetec.uap.wechat.model.Scheduling" parameterType="com.hyetec.uap.wechat.model.Scheduling" >
   select a.pk_id pkId , c.pk_id expertId , c.img expertUrl ,d.`name` expertLevel , 
   c.user_name expertName ,a.advice_date adviceDate ,a.start_time startTime ,a.end_time endTime
	 from f_scheduling a 
	LEFT JOIN f_expert b ON a.expert_id=b.user_id
	LEFT JOIN f_user c ON b.user_id=c.pk_id
	LEFT JOIN f_dictionary d ON b.`level`=d.sort 
    where  d.type = 'expertLevel' and a.`status` = 0 AND b.`status` = 0  AND b.Category = #{expertCategory,jdbcType=VARCHAR}   AND a.advice_date= #{adviceDate,jdbcType=DATE}
    AND TIME_FORMAT(a.start_time,'%H:%i:%s') &gt; TIME_FORMAT(SYSDATE(),'%H:%i:%s') and a.daf_end is null 
     ORDER BY a.start_time DESC 
  </select>
  
  <update id="delByPkId" parameterType="java.lang.Long" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update f_scheduling
    set status =1 
    where pk_id = #{pkId,jdbcType=BIGINT}
  </update>
  
  <update id="updateEndByPkId" parameterType="com.hyetec.uap.wechat.model.Scheduling" >
    <!--
      WARNING - @hyetec
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update f_scheduling
    set daf_end = 1
     <if test="endTime != null" >
         ,end_time = #{endTime,jdbcType=TIME}
      </if>
    where pk_id = #{pkId,jdbcType=BIGINT}
  </update>
  <select id="selectByCurrent" parameterType="java.lang.Long" resultType="com.hyetec.uap.wechat.model.Scheduling">
  
  	 select 
   		 s.pk_id pkId, s.expert_id expertId, s.advice_date adviceDate, s.start_time startTime, s.end_time endTime,
    	 	s.capacity , s.remark, s.status, s.create_time createTime,o.pk_id orderId
    			from f_scheduling  s join f_order o on (s.pk_id = o.scheduling_id)
				    <where>
				    	o.status = 0
				    	<if test="_parameter != null">
				    	and	enterprise_id = #{_parameter}
				    	</if>
				    	and s.daf_end is null 
				    	and s.status = 0
				    </where>
				    
				    <!-- order by s.advice_date desc -->
				    
				    order by s.advice_date asc
  
  </select>
</mapper>